#!/bin/bash -e
if [[ -n "${BUILD_INIT_CI}" || "$1 $2" == "ci init" ]]; then
  [ -z "${BUILD_CI_URL}" ] && BUILD_CI_URL=$(cd src; git ls-remote --get-url origin | sed -r 's/(.git)?$/-ci\1/g')
  (
    mkdir -p ci; cd ci;
    [ -d .git ] || git rev-parse --git-dir > /dev/null 2>&1 || git clone --depth=10 ${BUILD_CI_URL} . 1>&2
    git fetch ${BUILD_CI_URL} ${BUILD_CI_BRANCH:-HEAD} 1>&2 && git reset --hard 1>&2 && git clean -f -d -x 1>&2 && git checkout -q --detach FETCH_HEAD 1>&2
  ) || exit 1
  if [[ "$1 $2" != "ci init" ]]; then
    exit 0
  fi
fi

# limit resources for spawned processes
[ ! -d /sys/fs/cgroup/memory/build_buildenv ] || echo $$ > /sys/fs/cgroup/memory/build_buildenv/tasks

. /app/scripts/container_helpers.sh

if [ -n "${BUILD_INITIALIZE}" ]; then
  set +e
  rm opencv/.git/index.lock 2>/dev/null
  rm opencv_extra/.git/index.lock 2>/dev/null
  rm opencv_contrib/.git/index.lock 2>/dev/null
  rm opencv_extra/.git/refs/heads/master.lock 2>/dev/null
  opencv_worker_container_create ${BUILD_IMAGE:-opencv-ubuntu:14.04}
  opencv_worker_container_exec echo "Initialize"
  unset BUILD_INITIALIZE
#  opencv_worker_container_exec cmake "--version"
#  opencv_worker_container_exec ls -al /dev
#  opencv_worker_container_exec ls -aln /dev/dri || true
#  opencv_worker_container_exec id
#  opencv_worker_container_exec bash -c "export; id; whoami"
  #opencv_worker_container_exec sleep 30
  exit $?
fi
if [ -n "${BUILD_FINALIZE}" ]; then
  set +e
  if [ -n "${BUILD_SRC_OPENCV}" ]; then (set -e; cd $BUILD_SRC_OPENCV; echo "OpenCV:"; git status) fi
  if [ -n "${BUILD_SRC_OPENCV_CONTRIB}" ]; then (set -e; cd $BUILD_SRC_OPENCV_CONTRIB; echo "Contrib:"; git status) fi
  if [ -n "${BUILD_SRC_OPENCV_EXTRA}" ]; then (set -e; cd $BUILD_SRC_OPENCV_EXTRA; echo "Extra:"; git status) fi
  opencv_worker_container_dump_diff
  if [ ! -n "${BUILD_PRECOMMIT}" ]; then
    (cd build;
      make clean >/dev/null 2>&1 || true
      ninja clean >/dev/null 2>&1 || true
    )
  fi
  exit $?
fi
if [ -n "${BUILD_CLEANUP}" ]; then
  opencv_worker_container_cleanup
  exit $?
fi

export ANDROID_NDK=${ANDROID_NDK:-/opt/android/android-ndk-r10e/}
export ANDROID_SDK=${ANDROID_SDK:-/opt/android/android-sdk-java7/}
export NDKROOT=${ANDROID_NDK}

if [[ "$1" == "ci" ]]; then
  shift
  if [[ "${BUILD_CI_TARGET_OS}" == "linux" ]]; then
    SCRIPT=./ci/linux/$1
  else
    SCRIPT=./ci/linux-${BUILD_CI_TARGET_OS}/$1
  fi
  shift
  exec $SCRIPT "$@"
fi

opencv_worker_container_exec "$@"
